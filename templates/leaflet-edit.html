<!DOCTYPE html>
<html>


<head>
    <title>{{title}}</title>
    <meta name="og:image" content="{{preview_image_url}}" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.3/leaflet.css" integrity="sha256-iYUgmrapfDGvBrePJPrMWQZDcObdAcStKBpjP3Az+3s=" crossorigin="anonymous" />

    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0px;
            padding: 0px
        }

        #map {
            height: 100%;
            z-index: 0;
            background-color: rgb(27, 44, 51) !important;
        }

        #gmnoprint {
            width: auto;
        }

        {{custom_css}}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.3/leaflet.js" integrity="sha256-lwWHyfIX653fxmxYjZUYOSM7ufWv6dMT8ISVuTWwoOY=" crossorigin="anonymous"></script>
    <script src="https://factoriomaps.com/assets/js/leaflet/plugins/leaflet-fullHash/0.1.0/leaflet-fullHash.min.js"></script>
    <link href="https://factoriomaps.com/assets/js/leaflet/plugins/leaflet-fullscreen/1.0.1/leaflet.fullscreen.css" rel="stylesheet" />
    <script src="https://factoriomaps.com/assets/js/leaflet/plugins/leaflet-fullscreen/1.0.1/Leaflet.fullscreen.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pell/1.0.4/pell.min.css" integrity="sha256-Ld2o3+6zr33AQFbMa5nmnjrvJ+OgdEqYa72WW3LJcto=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pell/1.0.4/pell.min.js" integrity="sha256-uGxhgnjkTXSEUIUythHJUF0moiiFbSEWLyS7iA8Yv+E=" crossorigin="anonymous"></script>
    <script src="https://fastcdn.org/FileSaver.js/1.1.20151003/FileSaver.min.js"></script>
    <script src="https://factoriomaps.com/assets/js/leaflet/edit/2.0.0/edit.js"></script>
    <link href="https://factoriomaps.com/assets/css/leaflet/edit/2.0.0/edit.css" rel='stylesheet' />
</head>

<body>
    {{custom_buttons}}
    <div id="map" style="background: #1B2D33;"></div>
    <div style="position: fixed; top: 0; right: 0; height: 50px; width: 75px;">
        <button id="Cedar">CLICK ME TO EXPORT</button>
    </div>

    <script>
        var m = JSON.parse('{{map_json}}')
        var minZoom = 20;
        for (i = 0; i < m.meta.map.layers.length; i++) {
            var z = m.meta.map.layers[i].zoom.min;
            if(z < minZoom){
                minZoom = z;
            }
        }
        minZoom = minZoom - 2;
        if(minZoom < 1){
            minZoom = 1;
        }
        var layers = {};
        for (i = 0; i < m.meta.map.layers.length; i++) {
            layer = m.meta.map.layers[i];
            var tileUrl = layer.tiles.url;
            if (location.host !== "") {
                tileUrl = "https://factoriomaps.com/" + m.meta.map.path + "/" + tileUrl;
            }
            layers[layer.name] = L.tileLayer(tileUrl, {
                id: layer.name,
                attribution: '<a href="https://mods.factorio.com/mods/credomane/FactorioMaps">FactorioMaps</a>',
                minNativeZoom: layer.zoom.min,
                maxNativeZoom: layer.zoom.max,
                minZoom: minZoom,
                maxZoom: layer.zoom.max,
                noWrap: true,
                tileSize: layer.tiles.size,
                keepBuffer: 3
            });
        }
        var startZoom = m.meta.map.layers[0].zoom.min;
        var startCoords = [m.generation.leaflet.startCoords.x, m.generation.leaflet.startCoords.y];
        var map;
        if(m.generation.leaflet.crsSimple){
            map = L.map('map', {
                layers: [layers[m.meta.map.layers[0].name]],
                fadeAnimation: true,
                zoomAnimation: true,
                crs: L.CRS.Simple
            }).setView(startCoords, startZoom);
        }else{
            map = L.map('map', {
                layers: [layers[m.meta.map.layers[0].name]],
                fadeAnimation: true,
                zoomAnimation: true
            }).setView(startCoords, startZoom);
        }
        new L.Hash(map, layers);
        if (m.meta.map.layers.length > 1) {
            L.control.layers(layers, {}, { collapsed: m.meta.map.options.collapseLayerList }).addTo(map).setPosition('bottomright');
        }
        map.addControl(new L.Control.Fullscreen().setPosition('bottomright'));
        map.zoomControl.setPosition('bottomleft')

        mapCedar = Cedar.EditMap(map);
        if (m.meta.map.markers) {
            mapCedar.ImportData(m.meta.map.markers);
        }
        document.getElementById("Cedar").addEventListener("click", function () {
            var name = document.location.href.split("#")[0].replace(/[^A-Z0-9a-z]/g, "-") + ".json";
            saveAs(new Blob(["//#-# Source URL: " + document.location.href + "\n", JSON.stringify(mapCedar.ExportData()).replace('\\', '\\\\')], {
                type: "application/octet-stream;charset=utf8",
                endings: "native"
            }), name, false);
        });
    </script>
</body>

</html>
