"use strict";(function(a){a.Oak=function(e,t){var c={fn:{buildInfoBox:function(e,t){var n=document.createElement("div");n.classList.add("infoBox");c.fn.buildInfoBoxLine(n,"Submitter: ",t.source.user.username,false);c.fn.buildInfoBoxLine(n,"Map: ",t.map.title,false);c.fn.buildInfoBoxLine(n,"Submitted: ",new Date(t.source.submission.date).toString(),false);c.fn.buildInfoBoxLine(n,"Play time: ",t.map.details.playTime.ticks?t.map.details.playTime.hours+"h "+t.map.details.playTime.minutes+"m "+t.map.details.playTime.seconds+"s":null,true);c.fn.buildInfoBoxLine(n,"Seed: ",t.map.details.gen.seed,true);c.fn.buildInfoBoxLine(n,"Map exch.: ",c.fn.buildInfoMapExchangeString(t.map.details.gen.exchangeString),true);c.fn.buildInfoBoxLine(n,"Mods: ",c.fn.buildInfoModList(t.map.details.mods),true);c.fn.buildInfoBoxLine(n,"Contributors: ",c.fn.buildInfoContribList(t.map.contributors),true);n.addEventListener("click",function(){if(n.classList.contains("opened")){n.classList.remove("opened")}else{n.classList.add("opened")}});c.fn.injectInto(n,[c.fn.injectInto(document.createElement("div"),[c.fn.injectInto(document.createElement("span"),["Click for more info"]),c.fn.injectInto(document.createElement("label"),["Click for less info"])])]);e.appendChild(n)},buildInfoBoxLine:function(e,t,n,a){if(null===n){return null}var i=document.createElement("div");if(a){i.classList.add("extended")}return c.fn.injectInto(e,[c.fn.injectInto(i,[c.fn.injectInto(document.createElement("label"),[t]),c.fn.injectInto(document.createElement("span"),[n])])])},buildInfoContribList:function(e){if(e.length===0){return null}var t=document.createElement("ul");for(var n in e){if(e.hasOwnProperty(n)){c.fn.injectInto(t,[c.fn.injectInto(document.createElement("li"),[e[n].username])])}}return t},buildInfoMapExchangeString:function(e){if(!e){return null}var t=document.createElement("textarea");t.value=e;t.addEventListener("click",function(e){e.preventDefault();e.stopPropagation();return false});var n=document.createElement("a");n.classList.add("mapex-display");n.addEventListener("click",function(e){n.parentElement.parentElement.classList.add("mapex");e.preventDefault();e.stopPropagation();return false});return c.fn.injectInto(document.createElement("div"),[c.fn.injectInto(n,["Display"]),c.fn.injectInto(document.createElement("span"),["Map exchange string, copy before creating a game",document.createElement("br")," to have the same map settings as this map:",document.createElement("br"),t])])},buildInfoModList:function(e){if(!e||e.length===0){return null}var t=document.createElement("ul");for(var n in e){if(e.hasOwnProperty(n)){c.fn.injectInto(t,[c.fn.injectInto(document.createElement("li"),[c.fn.injectInto(document.createElement("label"),[e[n].name]),c.fn.injectInto(document.createElement("span"),[e[n].version])])])}}return t},buildMap:function(e){var t=e.meta&&e.meta.generation&&e.meta.generation.leaflet&&e.meta.generation.leaflet.startCoords&&[e.meta.generation.leaflet.startCoords.x||0,e.meta.generation.leaflet.startCoords.y||0]||[0,0],n={},a=null,i=null,o={layers:e.firstLayer,fadeAnimation:true,zoomAnimation:true};if(e.meta&&e.meta.generation&&e.meta.generation.leaflet&&e.meta.generation.leaflet.crsSimple){o["crs"]=L.CRS.Simple}if(e.markers&&e.markers.length>0){n={Markers:a=L.layerGroup(e.markers)};o["layers"]=[o["layers"],a]}if(e.countLayers===2&&false){c.fn.prepareLayerSlider()}else{if(e.countLayers>1||n){i=L.control.layers(e.countLayers>1?e.layers:{},n,{collapsed:e.meta.meta.map.options.collapseLayerList})}}e.map=L.map("map",o).setView(t,e.startZoom);if(i){i.addTo(e.map).setPosition("bottomright")}if(a){a.addTo(e.map);e.layers["_markers"]=a}new L.Hash(e.map,e.layers);e.map.addControl((new L.Control.Fullscreen).setPosition("bottomright"));e.map.zoomControl.setPosition("bottomleft")},buildMarker:function(e){return L.marker(e.coords,{title:e.title}).bindPopup(c.fn.buildMarkerPopup(e))},buildMarkerPopup:function(e){var t=document.createElement("div");t.innerHTML=e.text;return c.fn.injectInto(document.createElement("div"),[c.fn.injectInto(document.createElement("h3"),[e.title]),t])},buildMarkers:function(e,t){if(t&&Array.isArray(t)){for(var n=0;n<t.length;++n){e.markers.push(c.fn.buildMarker(t[n]))}}},buildSaveButton:function(e,r,t){if(t>0){var n=document.createElement("a"),l=document.getElementById("modal"),s=document.getElementById("save-download-container"),a=l.getElementsByClassName("close")[0],m=false,d=false;n.id="downBtn";n.appendChild(document.createTextNode("Download Save"));if(r.length===1){n.href=r[0].url;n.target="_blank"}else{n.addEventListener("click",function(){if(!m){if(!d){while(s.lastChild){s.removeChild(s.lastChild)}for(var e in r){if(r.hasOwnProperty(e)){var t=r[e];var n=document.createElement("li"),a=document.createElement("a"),i=document.createElement("span"),o=document.createElement("hr");o.classList.add("clear");a.classList.add("mapLayerLink");n.classList.add("mapLayer");c.fn.injectInto(a,["Download"]);a.target="_blank";if(!t.url){a.setAttribute("disabled","disabled");a.classList.add("disabled")}else{a.href=t.url}i.classList.add("mapLayerName");c.fn.injectInto(s,[c.fn.injectInto(n,[c.fn.injectInto(i,[t.layer]),a,o])])}}l.classList.add("open");m=true}}});a.addEventListener("click",function(){if(m){l.classList.remove("open");m=false}})}e.appendChild(n)}},findLayers:function(e,t){var n;for(var a=0;a<t.length;++a){n=t[a];var i=e.startZoom=Math.max(n.zoom.min-2,1);if(n.tiles.size===512){++e.startZoom}var o=n.tiles.url;if(location.host!==""){o="/"+e.meta.meta.map.path+"/"+o}if(n.tiles.backend&&n.tiles.backend.fullUrl&&n.tiles.backend.useMapImagesUrl){o=n.tiles.backend.fullUrl}var r={id:n.name,attribution:'<a href="https://mods.factorio.com/mods/credomane/FactorioMaps">FactorioMaps</a>',minNativeZoom:n.zoom.min,maxNativeZoom:n.zoom.max,minZoom:i,maxZoom:n.zoom.max,noWrap:true,tileSize:n.tiles.size,keepBuffer:3};if(n.bounds&&n.bounds.hasOwnProperty("southWest")&&n.bounds.hasOwnProperty("northEast")){r["bounds"]=[L.CRS.Simple.pointToLatLng(L.point(n.bounds.southWest.x*n.tiles.size,n.bounds.southWest.y*n.tiles.size),n.zoom.max),L.CRS.Simple.pointToLatLng(L.point(n.bounds.northEast.x*n.tiles.size,n.bounds.northEast.y*n.tiles.size),n.zoom.max)]}++e.countLayers;e.layers[n.name]=L.tileLayer(o,r);if(!e.firstLayer){e.firstLayer=e.layers[n.name]}if(n.save.download!==null&&n.save.download!==""){e.saves.push({layer:n.save.name||n.name,url:n.save.url});if(n.save.url){e.availableSaves++}}}},getFirstElement:function(e){return e&&Array.isArray(e)&&e.length?e.slice(0,1)[0]:null},init:function(t,e){c.fn.findLayers(t,t.meta.meta.map.layers);if(!t.availableSaves&&t.meta.links.save){t.saves.push({title:"Map download",url:t.meta.links.save});++t.availableSaves}c.fn.buildSaveButton(document.getElementById("buttonAnchor"),t.saves,t.availableSaves);if(!e){c.fn.buildMarkers(t,t.meta.meta.map.markers)}c.fn.buildMap(t);if(e){if(a.Cedar){t.cedar=a.Cedar.EditMap(map);if(m.meta.map.markers){t.cedar.ImportData(m.meta.map.markers)}document.getElementById("Cedar").addEventListener("click",function(){var e=document.location.href.split("#")[0].replace(/[^A-Z0-9a-z]/g,"-")+".json";a.saveAs(new Blob(["//#-# Source URL: "+document.location.href+"\n",JSON.stringify(t.cedar.ExportData()).replace("\\","\\\\")],{type:"application/octet-stream;charset=utf8",endings:"native"}),e,false)})}else{a.console.error("Map edit : Cedar module is not loaded.")}}c.fn.buildInfoBox(document.getElementById("buttonAnchor"),t.meta.meta)},injectInto:function(e,t){for(var n in t){if(t.hasOwnProperty(n)){if(t[n]instanceof Element){e.appendChild(t[n])}else{e.appendChild(document.createTextNode(t[n]))}}}return e}}};var n={layers:{},countLayers:0,firstLayer:null,markers:[],map:null,cedar:null,startZoom:1,saves:[],availableSaves:0,meta:e};c.fn.init(n,undefined===t?false:t);return{getMap:function(){return n.map}}}})(window);
