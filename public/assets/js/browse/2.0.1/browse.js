"use strict";(function(o,L,t,b,a,r){if(o.Browse){return}var w={monthMap:["Jan.","Feb.","Mar.","Apr.","May","Jun.","Jul.","Aug.","Sep.","Oct.","Nov.","Dec."],counter:0,regExs:{sliderTime:/(\d+)h\s+(\d+)m\s+(\d+)s/,number:/^\d+$/},props:{author:{prop:"author",url:"user",type:"string",search:"equal",model:"username",filter:"select",mapProp:function(t,e){if(!t.meta.source.user||!t.meta.source.user.username){return"anonymous"}if(e.authorList.filter(function(e){return e===t.meta.source.user.username}).length===0){e.authorList.push(t.meta.source.user.username)}return t.meta.source.user.username}},mods:{prop:"mods",url:"mods",type:"string",search:"equal",model:"mods",filter:"select",mapProp:function(t,e){if(!t.meta.map.details.mods){return[]}var a=[];for(var r in t.meta.map.details.mods){if(t.meta.map.details.mods.hasOwnProperty(r)){if(e.modList.filter(function(e){return e===t.meta.map.details.mods[r].name}).length===0){e.modList.push(t.meta.map.details.mods[r].name)}a.push(t.meta.map.details.mods[r].name)}}return a}},tags:{prop:"tags",url:"search",type:"string",search:"search",model:"tags",filter:"input",mapProp:function(e){var t=e.meta.tags||[];if(e.meta.map.title){t.push(e.meta.map.title)}if(e.meta.source.user&&e.meta.source.user.username){t.push(e.meta.source.user.username)}if(e.meta.map.contributors){for(var a in e.meta.map.contributors){if(e.meta.map.contributors.hasOwnProperty(a)&&e.meta.map.contributors[a].hasOwnProperty("username")){t.push(e.meta.map.contributors[a].username)}}}if(e.meta.map.details.mods){for(var a in e.meta.map.details.mods){if(e.meta.map.details.mods.hasOwnProperty(a)){t.push(e.meta.map.details.mods[a].name)}}}return t}},hasSave:{prop:"hasSave",url:"save",type:"boolean",search:"equal",model:"hasSave",filter:"boolean",mapProp:function(e){return!!e.links.save||e.meta.map.hasOwnProperty("layers")&&Array.isArray(e.meta.map.layers)&&e.meta.map.layers.filter(function(e){return!!e.save.download}).length>0}},isPublicServer:{prop:"isPublicServer",url:"public",type:"boolean",search:"equal",model:"isPublicServer",filter:"boolean",mapProp:".meta.map.options.publicServer"},isLayered:{prop:"isLayered",url:"layer",type:"boolean",search:"equal",model:"isLayered",filter:"boolean",mapProp:function(e){return e.meta.map.options.hasOwnProperty("layers")&&e.meta.map.options.layers>1}},isModded:{prop:"isModded",url:"modded",type:"boolean",search:"equal",model:"isModded",filter:"boolean",mapProp:".meta.map.options.modded"},playTime:{model:"playTime",filter:"slider",mapProp:function(e,t){if(e.meta.map.details.playTime.ticks>t.playTime.max){t.playTime.max=e.meta.map.details.playTime.ticks}if(null===t.playTime.min||e.meta.map.details.playTime.ticks<t.playTime.min){t.playTime.min=e.meta.map.details.playTime.ticks}return e.meta.map.details.playTime.ticks}},playTimemin:{prop:"playTimemin",url:"playStart",type:"integer",search:">=",model:"playTime"},playTimemax:{prop:"playTimemax",url:"playEnd",type:"integer",search:"<=",model:"playTime"}},counter:0,fn:{applyFilter:function(e){w.fn.setHistory(e);e.playTime.currentMin=null;e.playTime.currentMax=0;var t={};t[e.order]=false;e.isotope.arrange({filter:w.fn.buildFilterFunction(e),sortBy:e.order,sortAscending:t});e.playTime.element.noUiSlider.updateOptions({range:{min:Math.max(0,e.playTime.currentMin-60),max:e.playTime.currentMax+60}})},buildBrowse:function(e,t,a){w.fn.purgeElement(e.container);e.buttons=L.createElement("div");e.buttons.classList.add("isotope-filter-container");e.itemContainer=L.createElement("div");e.itemContainer.classList.add("isotope-item-container");e.itemContainer.classList.add("row");w.fn.injectInto(e.container,[e.buttons,e.itemContainer]);for(var r in t){if(t.hasOwnProperty(r)){w.fn.injectInto(e.itemContainer,[w.fn.buildBrowseBox(e,t[r])])}}w.fn.parseUrl(e,a);w.fn.initHistory(e);w.fn.initIsotope(e);w.fn.initLazyLoad(e);w.fn.buildFilter(e);w.fn.applyFilter(e)},buildBrowseBox:function(e,t){var a=L.createElement("div"),r=L.createElement("div"),i=L.createElement("div"),n=L.createElement("a"),s=L.createElement("img"),o=L.createElement("span"),l=L.createElement("span"),c=L.createElement("sup"),m=L.createElement("span"),u=L.createElement("hr"),p=new Date(!t.meta.source.hasOwnProperty("submission")||!t.meta.source.submission.hasOwnProperty("date")?"":t.meta.source.submission.date),d="",f=[];a.classList.add("Container-item");r.classList.add("header");i.classList.add("footer");o.classList.add("user");l.classList.add("date");m.classList.add("title");u.classList.add("clear");w.fn.injectInto(o,[t.meta.source.user.username||"Anonymous"]);if(t.meta.map.options.isPublicServer){a.classList.add("public-server")}if(t.meta.map.options.isAnonymous){a.classList.add("anonymous")}f.date=p;d=w.fn.getDateSuffix(p);w.fn.injectInto(c,[d]);w.fn.injectInto(l,[w.monthMap[p.getMonth()]," ",p.getDate(),c," ",p.getFullYear()]);w.fn.injectInto(m,[t.meta.map.title||"No world title"]);s.setAttribute("data-original",e.mapPreviewPrefix+t.links.preview);s.src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=";s.classList.add("lazyload");n.href=t.links.url;w.fn.injectInto(r,[o,l,u]);w.fn.injectInto(i,[m]);w.fn.injectInto(n,[s]);w.fn.injectInto(a,[r,i,n]);f.topMap=(t.meta.tags||[]).filter(function(e){return e==="featured"}).length>0;if(f.topMap){a.classList.add("featured")}for(var h in w.props){if(w.props.hasOwnProperty(h)){var y=w.props[h];if(y.hasOwnProperty("mapProp")){var b=null;if(typeof y.mapProp==="function"){b=y.mapProp(t,e)}else{var v=y.mapProp.replace(".","").split("."),g=t;for(var h in v){if(v.hasOwnProperty(h)&&g.hasOwnProperty(v[h])){g=g[v[h]]}}b=g}f[y.model]=b}}}e.isotopeData[++w.counter]=f;a.setAttribute("data-id",w.counter);a.setAttribute("data-date",t.meta.map.saveDate);a.setAttribute("data-order",(f.topMap?"1_":"0_")+t.meta.map.saveDate);a.setAttribute("data-subdate",t.meta.source.submission.date);a.setAttribute("data-suborder",(f.topMap?"1_":"0_")+t.meta.source.submission.date);return a},buildFilter:function(e){var t=L.createElement("div"),a=L.createElement("div"),r=L.createElement("div"),i=L.createElement("div"),n=L.createElement("div"),s=L.createElement("div"),o=L.createElement("div"),l=L.createElement("label"),c=L.createElement("div"),m=L.createElement("input"),u=L.createElement("label"),p=L.createElement("div"),d=L.createElement("hr"),f=[],h=L.createElement("div");a.classList.add("iso-filter-select-container");f.push(w.fn.filterSelect(e,a,"Author :","author","authorList",{}));t.classList.add("iso-filter-select-container");f.push(w.fn.filterSelect(e,t,"Mods :","mods","modList",{maxItems:5}));n.classList.add("iso-filter-public-container");n.classList.add("iso-filter-checkbox-container");f.push(w.fn.triStateCheckbox(e,n,"Public servers :","isPublicServer"));i.classList.add("iso-filter-modded-container");i.classList.add("iso-filter-checkbox-container");f.push(w.fn.triStateCheckbox(e,i,"Modded :","isModded"));r.classList.add("iso-filter-save-container");r.classList.add("iso-filter-checkbox-container");f.push(w.fn.triStateCheckbox(e,r,"Map download :","hasSave"));s.classList.add("iso-filter-layer-container");s.classList.add("iso-filter-checkbox-container");f.push(w.fn.triStateCheckbox(e,s,"Multiple Layers :","isLayered"));o.id=l.htmlFor="iso-filter-playtime";e.playTime.element=o;b.create(o,{start:[e.filters.playTimemin?e.filters.playTimemin:Math.max(0,e.playTime.min-60),e.filters.playTimemax?e.filters.playTimemax:e.playTime.max+60],tooltips:[true,true],step:1,margin:1,range:{min:Math.max(0,e.playTime.min-60),max:e.playTime.max+60},format:{to:function(e){var t=Math.floor(e/(60*60*60)),a=Math.floor((e-t*60*60*60)/(60*60)),r=Math.floor((e-(t*60*60*60+a*60*60))/60);return""+t+"h "+a+"m "+r+"s"},from:function(e){if(Number.isInteger(e)||w.regExs.number.test(e)){return e}var t=w.regExs.sliderTime.exec(e);e=60*(parseInt(t[1])*60*60+parseInt(t[2])*60+parseInt(t[3]));return e}}});o.noUiSlider.on("change",w.fn.noUiSliderChange.bind(o.noUiSlider,e,"playTime"));w.fn.injectInto(l,["Play time : "]);c.classList.add("iso-filter-playtime-container");w.fn.injectInto(c,[l,o]);if(e.filters.tags){m.value=e.filters.tags}u.htmlFor=m.id="iso-filter-searchbox";m.addEventListener("keyup",w.fn.inputSearchChange.bind(m,e,"tags"));w.fn.injectInto(u,["Search : "]);p.classList.add("iso-filter-search-container");w.fn.injectInto(p,[u,m]);d.classList.add("clear");d.classList.add("invisible");h.classList.add("iso-filter-select-container");w.fn.buildSortSelect(e,h,"Order By : ",{suborder:"Magic",subdate:"Submission date",date:"Save date"});w.fn.injectInto(e.buttons,[a,t,i,n,r,s,p,c,h,d]);for(var y in f){if(f.hasOwnProperty(y)&&f[y]&&typeof f[y]==="function"){f[y]()}}},buildFilterFunction:function(s){return function(e){var t=s.isotopeData[parseInt(e.getAttribute("data-id"))];for(var a in s.filters){if(s.filters.hasOwnProperty(a)&&w.props.hasOwnProperty(a)){var r=s.filters[a],i=w.props[a];if(i.type&&r!==undefined){var n=t[i.model];if(!(n!==undefined)){return false}if(!Array.isArray(n)){n=[n]}if(n.filter(function(t){switch(i.search){case"equal":if(Array.isArray(r)){if(r.filter(function(e){return e===t}).length!==1){return false}}else{if(t!==r){return false}}break;case"search":if(t.toLocaleLowerCase().indexOf(r.toLocaleLowerCase())===-1){return false}break;case">":if(t<=r){return false}break;case">=":if(t<r){return false}break;case"<":if(t>=r){return false}break;case"<=":if(t>r){return false}break}return true}).length<(Array.isArray(r)?r.length:1)){if(i.model==="playTime"){if(t.playTime>s.playTime.currentMax){s.playTime.currentMax=t.playTime}if(null===s.playTime.currentMin||t.playTime<s.playTime.currentMin){s.playTime.currentMin=t.playTime}}return false}}}}if(t.playTime>s.playTime.currentMax){s.playTime.currentMax=t.playTime}if(null===s.playTime.currentMin||t.playTime<s.playTime.currentMin){s.playTime.currentMin=t.playTime}return true}},buildSortSelect:function(t,e,a,r){var i=L.createElement("select"),n=L.createElement("label");w.fn.injectInto(n,[a]);for(var s in r){if(r.hasOwnProperty(s)){var o=L.createElement("option");o.value=s;w.fn.injectInto(o,[r[s]]);w.fn.injectInto(i,[o])}}n.htmlFor=i.id="sort-select";w.fn.injectInto(e,[n,i]);i.addEventListener("change",function(e){t.order=e.target[e.target.selectedIndex].value;w.fn.applyFilter(t)})},filterObject:function(a,r){var a=Object(a),i=[];Object.keys(a).forEach(function(e){var t=a[e];if(r(t,e,a)){i.push(t)}});return i},filterSelect:function(a,e,t,r,i,n){var s=L.createElement("select"),o=L.createElement("label"),l=L.createElement("option");if(n&&n.hasOwnProperty("maxItems")&&n.maxItems>1){s.multiple="multiple"}else{n.maxItems=1}a[i].sort(function(e,t){return e.toLocaleLowerCase()>t.toLocaleLowerCase()?1:-1});l.value="";w.fn.injectInto(l,[" - Select one to filter - "]);w.fn.injectInto(s,[l]);for(var c in a[i]){if(a[i].hasOwnProperty(c)){var m=L.createElement("option");w.fn.injectInto(m,[a[i][c]]);if(a.filters.hasOwnProperty(r)&&(Array.isArray(a.filters[r])&&a.filters[r].filter(function(e){return e===a[i][c]}).length===1||a.filters[r]===a[i][c])){m.selected=true}w.fn.injectInto(s,[m])}}s.addEventListener("change",function(e){a.filters[r]=null;var t=this.options[this.options.selectedIndex]?this.options[this.options.selectedIndex].value:null;if(t){a.filters[r]=t}else{delete a.filters[r]}w.fn.applyFilter(a)});s.id=o.htmlFor="iso-filter-"+r;w.fn.injectInto(o,[t]);w.fn.injectInto(e,[o,s]);return function(){$(s).selectize(n).on("change",function(e){var t=$.makeArray($(this).children().map(function(e,t){return t.value}));a.filters[r]=null;if(t.length>0){a.filters[r]=t.length===1?t[0]:t}else{delete a.filters[r]}w.fn.applyFilter(a)})}},generateUrl:function(e){var t="";for(var a in w.props){if(w.props.hasOwnProperty(a)){var r=w.props[a],i=null;if(e.filters.hasOwnProperty(r.prop)&&e.filters[r.prop]!==undefined){switch(r.type){case"boolean":i=e.filters[r.prop]?"true":"false";break;case"string":case"integer":default:i=JSON.stringify(e.filters[r.prop])}t+="&"+r.url+"="+o.encodeURIComponent(i)}}}return o.location.pathname+t.replace("&","?")},getDateSuffix:function(e){var t="";switch(e.getDate()){case 1:case 11:case 21:case 31:t="st";break;case 2:case 22:t="nd";break;case 3:case 32:t="rd";break;default:t="th"}return t},initHistory:function(e){},initIsotope:function(e){e.isotope=new t(e.itemContainer,{getSortData:{suborder:"[data-suborder]",order:"[data-order]",subdate:"[data-subdate]",date:"[data-date]"}})},initLazyLoad:function(e){if(r.fn.lazyload){e.lazyImgs=$("img.lazyload");e.lazyLoad=e.lazyImgs.lazyload({failure_limit:Math.max(e.lazyImgs.length-1,0),event:"lazylazy"});e.isotope.on("layoutComplete",function(){w.fn.lazyLoadImgs(e,"lazylazy")});$(o).on("scroll",function(){w.fn.lazyLoadImgs(e,"lazylazy")})}},injectInto:function(e,t){for(var a in t){if(t.hasOwnProperty(a)){if(t[a]instanceof Element){e.appendChild(t[a])}else{e.appendChild(L.createTextNode(t[a]))}}}},inputSearchChange:function(e,t){if(this.value){e.filters[t]=this.value}else{delete e.filters[t]}w.fn.applyFilter(e)},lazyLoadImgs:function(e,t){e.lazyImgs.filter(function(){var e=this.getBoundingClientRect();return e.top>=0&&e.top<=o.innerHeight}).trigger(t)},noUiSliderChange:function(e,t,a,r,i){e.filters[t+"min"]=parseFloat(i[0]);e.filters[t+"max"]=parseFloat(i[1]);w.fn.applyFilter(e)},parseUrl:function(e,t){var a=t.replace("?","").split("&");if(a.length>0){e.filters={};for(var r in a){if(a.hasOwnProperty(r)){var i=a[r].split("=");if(!(i[1]===undefined)){var n=o.decodeURIComponent(i[1]),s=w.fn.filterObject(w.props,function(e){return e.url===i[0]});if(s.length===1&&(s=s[0])){switch(s.type){case"boolean":n=n==="true";break;case"integer":n=parseFloat(n);break}try{e.filters[s.prop]=JSON.parse(n)}catch(r){o.console.error("Failure parsing JSON")}}}}}}},purgeElement:function(e){while(e.lastChild){e.removeChild(e.lastChild)}},setHistory:function(e){if(a){a.replaceState(e.filters,"",w.fn.generateUrl(e))}},triStateCheckbox:function(e,t,a,r){var i=L.createElement("input"),n=L.createElement("label"),s="iso-filter-cb-"+r;i.type="checkbox";i.id=n.htmlFor=s;w.fn.injectInto(n,[a]);switch(true){case e.filters[r]===true:i.indeterminate=false;i.checked=true;i.setAttribute("state","checked");break;case e.filters[r]===false:i.indeterminate=false;i.checked=false;i.setAttribute("state","unchecked");break;default:i.indeterminate=true;i.checked=false;i.setAttribute("state","none");break}i.addEventListener("click",w.fn.triStateCheckboxClick.bind(i,e,r));w.fn.injectInto(t,[n,i]);return null},triStateCheckboxClick:function(e,t,a){switch(this.getAttribute("state")){case"none":this.checked=true;this.indeterminate=false;this.setAttribute("state","checked");e.filters[t]=true;break;case"checked":this.checked=false;this.setAttribute("state","unchecked");e.filters[t]=false;break;case"unchecked":this.indeterminate=true;delete e.filters[t];this.setAttribute("state","none");break}a.stopPropagation();w.fn.applyFilter(e);return false}}};o.Browse=function(e,t,a,r){var i=L.getElementById(t),n={isotopeData:{},authorList:[],modList:[],playTime:{min:null,max:0,currentMin:null,currentMax:null},search:null,filters:{},isotope:null,lazyLoad:null,lazyImgs:null,container:i,mapPreviewPrefix:a,order:"suborder"};if(n.container){n.container.innerHTML="Downloading map data...";var s=new XMLHttpRequest;s.onreadystatechange=function(e){if(this.readyState===XMLHttpRequest.DONE){if(this.status>199&&this.status<300){try{n.container.innerHTML="Building page...";w.fn.buildBrowse(n,JSON.parse(this.responseText),r)}catch(e){n.container.innerHTML="An error has occured<br />Please drop by Discord to tell us how badly it affects your Factorio addiction.<br />100% no biters. 0% no bots.";o.console.error("Error parsing map data",e)}}else{n.container.innerHTML="Unable to fetch maps, please retry later.<br />Or stop by the Discord to see if there's an update in progress. 100% no worms. 0% no belts.";o.console.error("Error querying maps data",this)}}};s.open("GET",e,true);s.send(null)}else{o.console.error("No container")}}})(window,document,window.Isotope,window.noUiSlider,window.history,window.jQuery);
